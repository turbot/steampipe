{{ define "outlet" }}[  {{ range .ControlRuns -}} {{ range .Rows }} {{ template "control_run_template" . -}} {{ end -}} {{ end }}
] {{ end }}
{{ define "control_run_template" }}
{
    "SchemaVersion": "2018-10-08",
    "Id": "{{ .Control.FullName }}",
    "ProductArn": "arn:aws:securityhub:{{ . | GetDimensionRegion }}:{{ . | GetDimensionAccount }}:product/{{ . | GetDimensionAccount }}/default",
    "ProductFields": {
        "ProviderName": "Steampipe",
        "ProviderVersion": "{{ steampipeversion }}"
    },
    "GeneratorId": "steampipe-{{ .Control.ShortName }}",
    "AwsAccountId": "{{ . | GetDimensionAccount }}",
    "Types": [
        "automated"
    ],
    "UpdatedAt": "{{ timenow }}",
    "CreatedAt": "{{ timenow }}",
    "Title": "{{ .Control.Title }}",
    "Description": "{{ .Control.Description }}",{{ with .Control.Severity }}
    "Severity": {
        "Label": "{{ . | ToUpper}}"
    },{{ else }}
    "Severity": {
        "Label": "INFORMATIONAL"
    },{{ end }}
    "Resources": [
        { 
            "Type": "Other",
            "Id": "{{ .Resource }}"
        }
    ],
    "Compliance": {
        "Status": "{{ template "statusmap" .Status -}}"
    }
},{{ end -}}

{{ define "statusmap" }}{{ if eq . "ok" }}PASSED{{ end -}}{{ if eq . "error" }}WARNING{{ end -}}{{ if eq . "alarm" }}FAILED{{ end -}}{{ if eq . "skip" }}NOT_AVAILABLE{{ end -}}{{ if eq . "info" }}NOT_AVAILABLE{{ end -}}{{ end -}}